<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Batalla de Roedores Online</title>
<style>
body { background: linear-gradient(#19191a,#04293a); font-family: 'PixelOperator', monospace; color:#fff; text-align:center; margin:0; padding:0;}
#game-container { width:90%; max-width:720px; margin:20px auto; border:4px solid #000; background:#fff8e7; border-radius:12px; box-shadow:0 0 10px #0005; padding:15px; color:#111; position:relative;}
h2 { margin:8px 0 12px 0; color:#080808; }
#battlefield { position:relative; width:100%; height:260px; background: url("fondo_bosque.png") no-repeat center center / cover; border:2px solid #000; margin-bottom:15px; border-radius:8px; overflow:hidden; }
#player,#enemy { position:absolute; bottom:20px; width:120px; image-rendering:pixelated; transition: transform 0.4s ease; }
#player{ left:30px } #enemy{ right:30px; transform:scaleX(-1); }
#question-container { background:#f0e68c; border:2px solid #000; border-radius:8px; padding:10px; margin-bottom:10px; }
.option { display:block; background:#fff; border:2px solid #000; border-radius:6px; padding:8px; margin:6px auto; width:90%; cursor:pointer; font-weight:bold; }
.option:hover{ background:#cde } .option:disabled{ opacity:0.6; cursor:default }
#special-button { background:#ffeb3b; border:3px solid #000; border-radius:6px; padding:8px; cursor:pointer; margin-top:5px; font-weight:bold; }
#special-button:disabled { opacity:0.6; cursor:default }
#log { background:#fff; border:2px solid #000; border-radius:6px; height:100px; overflow-y:auto; padding:5px; text-align:left; font-size:12px; color:#000; }
#status-bar { font-weight:bold; font-size:16px; margin-bottom:6px; color:#000; }
#energy-container { display:flex; justify-content:center; gap:6px; margin:5px auto; }
.energy-segment { width:60px; height:18px; background:#ddd; border:2px solid #000; border-radius:6px; overflow:hidden; }
.energy-fill { height:100%; width:0%; background:#00bcd4; transition: width 0.3s; }
.energy-fill.full { width:100%; background:#ffeb3b; animation: pulseEnergy 1s infinite alternate; }
@keyframes pulseEnergy { 0%{ filter:brightness(1);} 100%{ filter:brightness(1.6);} }
</style>
</head>
<body>
<div id="game-container">
  <h2>Roedores a por la supervivencia Online</h2>

  <div id="player-list">
    <p>Jugadores en sala:</p>
    <ul id="players-ul"></ul>
  </div>

  <button id="start-btn">Comenzar Partida</button>

  <div id="battlefield">
    <img id="player" src="" alt="Jugador">
    <img id="enemy" src="" alt="Enemigo">
    <div id="log"></div>
  </div>

  <div id="status-bar">
    Salud: <span id="player-health">0</span> | Rival: <span id="enemy-health">0</span>
  </div>

  <div id="energy-container">
    <div class="energy-segment"><div id="energy1" class="energy-fill"></div></div>
    <div class="energy-segment"><div id="energy2" class="energy-fill"></div></div>
    <div class="energy-segment"><div id="energy3" class="energy-fill"></div></div>
  </div>

  <div id="question-container">
    <p id="question-text">Esperando partida...</p>
    <div id="options"></div>
  </div>

  <button id="special-button" disabled>Habilidad Especial</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let playerId=null;
let playerData=null;
let rivalData=null;
let currentQuestion=null;
let energySegments=0;

// UI elements
const playersUl = document.getElementById("players-ul");
const startBtn = document.getElementById("start-btn");
const playerImg = document.getElementById("player");
const enemyImg = document.getElementById("enemy");
const logDiv = document.getElementById("log");
const questionText = document.getElementById("question-text");
const optionsDiv = document.getElementById("options");
const specialButton = document.getElementById("special-button");

// =================== CONEXIÓN ===================
socket.on("connect", ()=>{
  playerId = socket.id;
  log("Conectado al servidor. Esperando jugadores...");
});

socket.on("updatePlayerList", data=>{
  playersUl.innerHTML = "";
  data.forEach(p=>{ 
    const li = document.createElement("li"); 
    li.textContent = p.name + (p.id===playerId ? " (Tú)" : "");
    playersUl.appendChild(li);
  });
});

startBtn.onclick = ()=>{
  socket.emit("startGame");
  startBtn.disabled=true;
};

// =================== PREGUNTAS ===================
socket.on("newQuestion", data=>{
  currentQuestion = data;
  questionText.textContent = data.q;
  optionsDiv.innerHTML="";
  data.options.forEach((opt,i)=>{
    const btn = document.createElement("button");
    btn.className="option";
    btn.textContent=opt;
    btn.onclick = ()=>{ socket.emit("answer", {playerId, answer:i}); setOptionsEnabled(false); }
    optionsDiv.appendChild(btn);
  });
  setOptionsEnabled(true);
});

function setOptionsEnabled(enabled){
  const btns = document.querySelectorAll("#options button");
  btns.forEach(b=>b.disabled = !enabled);
}

// =================== ATAQUES EN TIEMPO REAL ===================
socket.on("updateBattle", data=>{
  if(data.player.id===playerId) playerData = data.player;
  else rivalData = data.player;

  playerImg.src = playerData.charImg;
  enemyImg.src = rivalData.charImg;
  document.getElementById("player-health").textContent = playerData.health;
  document.getElementById("enemy-health").textContent = rivalData.health;

  // Animaciones
  if(data.attack){
    if(data.attack.type==="normal"){
      enemyImg.style.transform="scaleX(-1) translateX(20px)";
      setTimeout(()=>{enemyImg.style.transform="scaleX(-1) translateX(0)";},300);
    }
    else if(data.attack.type==="special"){
      switch(data.player.charName){
        case "Ardilla Roja":
          const nuez = document.createElement("img");
          nuez.src="nuez.png";
          nuez.style.position="absolute"; nuez.style.bottom="40px"; nuez.style.left="50px";
          nuez.style.width="40px"; nuez.style.height="40px"; nuez.style.transition="all 0.6s linear"; nuez.style.zIndex="10";
          document.getElementById("battlefield").appendChild(nuez);
          let rot=0;
          const rotInterval = setInterval(()=>{ rot+=30; nuez.style.transform=`rotate(${rot}deg)`; },50);
          setTimeout(()=>{ clearInterval(rotInterval); nuez.style.left="450px"; nuez.style.bottom="60px"; nuez.style.width="80px"; nuez.style.height="80px"; },50);
          setTimeout(()=>{ nuez.remove(); enemyImg.style.transform="scaleX(-1) translateX(15px)"; setTimeout(()=>{enemyImg.style.transform="scaleX(-1) translateX(0)";},300); },600);
          break;
        case "Ratón":
          enemyImg.style.transform="scaleX(-1) translateX(40px)";
          setTimeout(()=>{enemyImg.style.transform="scaleX(-1) translateX(-20px)";},200);
          setTimeout(()=>{enemyImg.style.transform="scaleX(-1) translateX(0)";},400);
          break;
        case "Capibara":
          enemyImg.style.filter="brightness(2) drop-shadow(0 0 15px limegreen)";
          setTimeout(()=>{enemyImg.style.filter="none";},1200);
          break;
      }
    }
  }

  // Especial listo
  if(playerData.specialReady) specialButton.disabled=false;
  else specialButton.disabled=true;
});

// =================== USO DE HABILIDAD ===================
specialButton.onclick = ()=>{
  if(!playerData.specialReady) return;
  socket.emit("useSpecial", {playerId});
  specialButton.disabled=true;
};

// =================== LOG ===================
socket.on("log", msg=>{
  log(msg);
});

function log(msg){
  logDiv.innerHTML+=msg+"<br>";
  logDiv.scrollTop=logDiv.scrollHeight;
}
</script>
</body>
</html>
