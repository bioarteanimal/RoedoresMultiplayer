<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Batalla de Roedores Online</title>
<style>
  body { background: linear-gradient(#19191a,#04293a); font-family: 'PixelOperator', monospace; color:#fff; text-align:center; margin:0; padding:0;}
  #game-container { width:90%; max-width:720px; margin:20px auto; border:4px solid #000; background:#fff8e7; border-radius:12px; box-shadow:0 0 10px #0005; padding:15px; color:#111; position:relative;}
  h2 { margin:8px 0 12px 0; color:#080808; }
  .health-bar { height:20px; width:90%; max-width:500px; background:#ddd; border:2px solid #000; margin:5px auto; border-radius:8px; overflow:hidden; }
  .health-fill { height:100%; background:#4caf50; width:100%; max-width:100%; transition: width 0.3s; }
  #battlefield { position:relative; width:100%; height:260px; background: url("fondo_bosque.png") no-repeat center center / cover; border:2px solid #000; margin-bottom:15px; border-radius:8px; overflow:hidden; }
  #player,#enemy { position:absolute; bottom:20px; width:120px; image-rendering:pixelated; transition: transform 0.4s ease; }
  #player{ left:30px } #enemy{ right:30px; transform:scaleX(-1); }
  #question-container { background:#f0e68c; border:2px solid #000; border-radius:8px; padding:10px; margin-bottom:10px; }
  .option { display:block; background:#fff; border:2px solid #000; border-radius:6px; padding:8px; margin:6px auto; width:90%; cursor:pointer; font-weight:bold; }
  .option:hover{ background:#cde } .option:disabled{ opacity:0.6; cursor:default }
  #log { background:#fff; border:2px solid #000; border-radius:6px; height:100px; overflow-y:auto; padding:5px; text-align:left; font-size:12px; color:#000; }
  #special-button { background:#ffeb3b; border:3px solid #000; border-radius:6px; padding:8px; cursor:pointer; margin-top:5px; font-weight:bold; }
  #special-button:disabled { opacity:0.6; cursor:default }
  #game-over { display:none; background:rgba(0,0,0,0.7); position:absolute; top:0; left:0; right:0; bottom:0; color:white; font-size:16px; justify-content:center; align-items:center; flex-direction:column; z-index:20; }
  #restart-btn { background:#00e676; border:2px solid #000; padding:10px; cursor:pointer; border-radius:6px; margin-top:10px; font-weight:bold; }
  #character-selection button{ margin:5px; padding:8px; cursor:pointer; font-weight:bold; }
  #status-bar { font-weight:bold; font-size:16px; margin-bottom:6px; color:#000; }

  #energy-container { display:flex; justify-content:center; gap:6px; margin:5px auto; }
  .energy-segment { width:60px; height:18px; background:#ddd; border:2px solid #000; border-radius:6px; overflow:hidden; }
  .energy-fill { height:100%; width:0%; background:#00bcd4; transition: width 0.3s; }
  .energy-fill.full { width:100%; background:#ffeb3b; animation: pulseEnergy 1s infinite alternate; }
  @keyframes pulseEnergy { 0%{ filter:brightness(1);} 100%{ filter:brightness(1.6);} }
</style>
</head>
<body>
<div id="game-container">
  <h2>Roedores Online: Batalla</h2>

  <div id="lobby">
    <p>Nombre del jugador: <input type="text" id="playerName" placeholder="Tu nombre"></p>
    <button id="join-btn">Unirse</button>
    <div id="players-list"></div>
    <button id="start-btn" disabled>Comenzar Batalla</button>
  </div>

  <div id="character-selection" style="display:none;">
    <p>Elige tu personaje:</p>
    <button onclick="selectPlayer(0)">Ardilla Roja</button>
    <button onclick="selectPlayer(1)">RatÃ³n</button>
    <button onclick="selectPlayer(2)">Capibara</button>
  </div>

  <div id="battlefield" style="display:none;">
    <img id="player" src="" alt="Jugador">
    <img id="enemy" src="" alt="Rival">
    <div id="game-over" style="display:flex">
      <p id="game-over-text">ðŸŽ‰ Â¡Juego terminado! ðŸŽ‰</p>
      <button id="restart-btn">Jugar nueva partida</button>
    </div>
  </div>

  <div id="status-bar" style="display:none;">
    Salud: <span id="player-health-display">0</span>/<span id="player-max-health">0</span> | 
    Rival: <span id="enemy-health-display">0</span>/<span id="enemy-max-health">0</span> | 
    Tiempo: <span id="timer-display">30</span>s
  </div>

  <div id="question-container" style="display:none;">
    <p id="question-text"></p>
    <div id="options"></div>
  </div>

  <button id="special-button" disabled style="display:none;">Habilidad Especial</button>
  <div id="log"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
// ===================== SOCKET.IO =====================
const socket = io();
let playerId = null;
let playerData = null;
let rivalData = null;
let currentQuestion = null;
let timerInterval = null;
let timeLeft = 30;

// ===================== LOBBY =====================
const joinBtn = document.getElementById("join-btn");
const startBtn = document.getElementById("start-btn");
const playerNameInput = document.getElementById("playerName");
const playersListDiv = document.getElementById("players-list");

joinBtn.onclick = () => {
  const name = playerNameInput.value.trim();
  if(!name) return alert("Escribe tu nombre");
  socket.emit("joinLobby", name);
  joinBtn.disabled = true;
};

startBtn.onclick = () => {
  socket.emit("startBattle");
};

socket.on("updateLobby", players => {
  playersListDiv.innerHTML = players.map(p => p.name).join("<br>");
  startBtn.disabled = players.length<2;
});

socket.on("playerId", id => { playerId = id; });

// ===================== PERSONAJES =====================
const players = [
  { name: "Ardilla Roja", img: "Ardilla roja.png", attackImg: "Ardilla_ataque.png", maxHealth: 100 },
  { name: "RatÃ³n", img: "Raton.png", attackImg: "Raton_ataque.png", maxHealth: 80 },
  { name: "Capibara", img: "Capibara.png", attackImg: "Capibara_ataque.png", maxHealth: 120 }
];

function selectPlayer(index) {
  playerData = { ...players[index], health: players[index].maxHealth, streak: 0, specialReady:false };
  document.getElementById("player").src = playerData.img;
  document.getElementById("character-selection").style.display="none";
  document.getElementById("battlefield").style.display="block";
  document.getElementById("status-bar").style.display="block";
  document.getElementById("question-container").style.display="block";
  document.getElementById("special-button").style.display="block";
  socket.emit("characterSelected", index);
}

// ===================== PREGUNTAS =====================
const questions = [
  { q:"Â¿QuÃ© orden de mamÃ­feros es el mÃ¡s diverso?", options:["Carnivora","Rodentia","Chiroptera","Primates"], correct:1 },
  { q:"Â¿CuÃ¡ntas especies aproximadas de roedores existen?", options:["500","1.200","2.050","4.000"], correct:2 },
  { q:"Â¿En quÃ© continente no se encuentran los roedores?", options:["Asia","OceanÃ­a","Ãfrica","AntÃ¡rtida"], correct:3 },
  { q:"Â¿CuÃ¡l de estos NO pertenece a Rodentia?", options:["HÃ¡mster","Conejillo de Indias","MurciÃ©lago","Capibara"], correct:2 }
  // puedes aÃ±adir mÃ¡s...
];

function displayQuestion(q) {
  currentQuestion = q;
  document.getElementById("question-text").textContent = q.q;
  const optionsDiv = document.getElementById("options");
  optionsDiv.innerHTML = "";
  q.options.forEach((opt,i)=>{
    const btn = document.createElement("button");
    btn.textContent = opt;
    btn.className="option";
    btn.onclick = ()=>submitAnswer(i);
    optionsDiv.appendChild(btn);
  });
  timeLeft = 30;
  document.getElementById("timer-display").textContent=timeLeft;
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    timeLeft--;
    document.getElementById("timer-display").textContent=timeLeft;
    if(timeLeft<=0){
      clearInterval(timerInterval);
      socket.emit("timeOut");
    }
  },1000);
}

function submitAnswer(index){
  clearInterval(timerInterval);
  socket.emit("answer", { answer:index, time:30-timeLeft });
}

// ===================== RECEPCIÃ“N DE DATOS =====================
socket.on("nextQuestion", q=>displayQuestion(q));

socket.on("updateHealth", data=>{
  if(playerId===data.playerId){
    playerData.health=data.health;
    document.getElementById("player-health-display").textContent=data.health;
    document.getElementById("player-max-health").textContent=playerData.maxHealth;
  } else {
    rivalData=data;
    document.getElementById("enemy-health-display").textContent=data.health;
    document.getElementById("enemy-max-health").textContent=data.maxHealth;
    document.getElementById("enemy").src=players[data.charIndex].img;
  }
});

socket.on("attackAnimation", data=>{
  if(playerId===data.playerId)return; // no animar mi propio ataque
  const enemyImg = document.getElementById("enemy");
  switch(data.type){
    case "normal":
      enemyImg.style.transform="scaleX(-1) translateX(20px)";
      setTimeout(()=>{enemyImg.style.transform="scaleX(-1) translateX(0)";},300);
      break;
    case "special":
      if(data.charName==="Ardilla Roja"){
        const nuez = document.createElement("img");
        nuez.src="nuez.png";
        nuez.style.position="absolute"; nuez.style.bottom="40px"; nuez.style.left="50px"; nuez.style.width="40px"; nuez.style.height="40px"; nuez.style.transition="all 0.5s linear"; nuez.style.zIndex="10";
        document.getElementById("battlefield").appendChild(nuez);
        setTimeout(()=>{ nuez.style.left="450px"; nuez.style.bottom="60px"; nuez.style.width="80px"; nuez.style.height="80px"; nuez.remove();},500);
      } else if(data.charName==="RatÃ³n"){
        enemyImg.style.transform="scaleX(-1) translateX(50px)";
        setTimeout(()=>{enemyImg.style.transform="scaleX(-1) translateX(0)";},400);
      } else if(data.charName==="Capibara"){
        enemyImg.style.filter="brightness(1.5) drop-shadow(0 0 10px limegreen)";
        setTimeout(()=>{enemyImg.style.filter="none";},1200);
      }
      break;
  }
});

socket.on("battleEnd", data=>{
  clearInterval(timerInterval);
  alert(data.msg);
  location.reload();
});
</script>
</body>
</html>
